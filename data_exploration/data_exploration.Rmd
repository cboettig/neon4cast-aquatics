---
title: "exploration"
output: html_document
---

# In this first Part, I import all the relevant data from NEON;  data exploration stuff starts at line 241 
```{r}
library(neonstore)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(lubridate)

Sys.setenv("NEONSTORE_HOME" = "neon_store/")
if(!dir.exists("neon_store/")){
  dir.create("neon_store/")
}
```

This should work now!
```{r}
focal_sites <- c("BARC", "POSE")
# Will download everything the first time, and then only download updated files:
#Water quality
neonstore::neon_download("DP1.20288.001", site =  focal_sites, type = "basic", .token = Sys.getenv("NEON_TOKEN"))
#Precipiation: NOT WORKING!
#neonstore::neon_download("DP1.00006.001", site =  focal_sites, type = "basic", .token = Sys.getenv("NEON_TOKEN"))
# Wind Speed
neonstore::neon_download("DP1.20059.001", site =  focal_sites, type = "basic", .token = Sys.getenv("NEON_TOKEN"))
# Barometric Pressure
neonstore::neon_download("DP1.20004.001", site =  focal_sites, type = "basic", .token = Sys.getenv("NEON_TOKEN"))
# Air Temperature
neonstore::neon_download("DP1.20046.001", site =  focal_sites, type = "basic", .token = Sys.getenv("NEON_TOKEN"))
# PAR at water surface
neonstore::neon_download("DP1.20042.001", site =  focal_sites, type = "basic", .token = Sys.getenv("NEON_TOKEN"))
# PAR below water surface
neonstore::neon_download("DP1.20261.001", site =  focal_sites, type = "basic", .token = Sys.getenv("NEON_TOKEN"))
# Elevation of surface water
neonstore::neon_download("DP1.20016.001", site =  focal_sites, type = "basic", .token = Sys.getenv("NEON_TOKEN"))
# Groundwater temperature
neonstore::neon_download("DP1.20217.001", site =  focal_sites, type = "basic", .token = Sys.getenv("NEON_TOKEN"))
# Nitrate in surface water
neonstore::neon_download("DP1.20033.001", site =  focal_sites, type = "basic", .token = Sys.getenv("NEON_TOKEN"))



# will import downloaded files into local SQL DB:
neonstore::neon_store(product = "DP1.20288.001", type = "basic") #Water Quality
#neonstore::neon_store(product = "DP1.00006.001", type = "basic") # Precip
neonstore::neon_store(product = "DP1.20059.001", type = "basic") # Wind Speed
neonstore::neon_store(product = "DP1.20004.001", type = "basic") # pressure
neonstore::neon_store(product = "DP1.20046.001", type = "basic") # temperature
neonstore::neon_store(product = "DP1.20042.001", type = "basic") # PAR surface
neonstore::neon_store(product = "DP1.20261.001", type = "basic") # PAR below
neonstore::neon_store(product = "DP1.20016.001", type = "basic") # Elevation of surface water
neonstore::neon_store(product = "DP1.20217.001", type = "basic") # Groundwater temperature
neonstore::neon_store(product = "DP1.20033.001", type = "basic") # Nitrate


# Use a remote connection, so `dplyr` operations can be run by SQL:
waq_con <- neon_db()
waq <- tbl(waq_con, "waq_instantaneous-basic")
#precip_con <- neon_db()
# precip <- 
wind_con <- neon_db()
wind <- tbl(wind_con, "WSDBuoy_30min-basic")
pressure_con <- neon_db()
pressure <- tbl(pressure_con, "BP_30min-basic")
airT_con <- neon_db()
airT <- tbl(airT_con, "RHbuoy_30min-basic")
PARsurf_con <- neon_db()
PARsurf <- tbl(PARsurf_con, "PARWS_30min-basic")
PARbelow_con <- neon_db() 
PARbelow <- tbl(PARbelow_con, "uPAR_30min-basic")
elevSurf_con <- neon_db()
elevSurf <- tbl(elevSurf_con, "EOS_30_min-basic")
waterT_con <- neon_db()
waterT <- tbl(waterT_con, "TGW_30_minute-basic")
nitrate_con <- neon_db()
nitrate <- tbl(nitrate_con, "NSW_15_minute-basic")
```

The rest is not going to work now! TO BE UPDATED! 

Tidying up DO data, for exploration purposes I'm only going to look at the means here on but for forecasting, dealing with uncertainty will probably be the way to go.
```{r}
oxy <- oxy$waq_instantaneous %>%
  filter(is.na(dissolvedOxygen) != TRUE)

oxy_cleaned <- oxy %>%
  dplyr::select(siteID, startDateTime, sensorDepth, dissolvedOxygen,
                dissolvedOxygenExpUncert,dissolvedOxygenFinalQF) %>%
  dplyr::filter(dissolvedOxygenFinalQF == 0,
                sensorDepth > 0) %>%
  dplyr::mutate(startDateTime = as_datetime(startDateTime)) %>%
  dplyr::mutate(date = as_date(startDateTime),
                hour = hour(startDateTime)) %>%
  dplyr::group_by(siteID, date, hour) %>%
  dplyr::summarize(sensorDepth = mean(sensorDepth, na.rm = TRUE),
                   dissolvedOxygen = mean(dissolvedOxygen, na.rm = TRUE),
                   dissolvedOxygenExpUncert = mean(dissolvedOxygenExpUncert, na.rm = TRUE),
                   sensorDepth = mean(sensorDepth, na.rm = TRUE), .groups = "drop") %>%
  dplyr::mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  dplyr::select(siteID, startDateTime, sensorDepth, dissolvedOxygen, dissolvedOxygenExpUncert)
```

Cleaning up precipitation data and merging with DO table.
```{r}
site_change <- function(x) {
  if (x == "OSBS"){return("BARC")}
  else{return("POSE")}
}

precipitation_cleaned <- precipitation$THRPRE_30min %>%
  dplyr::select(siteID, startDateTime, TFPrecipBulk) %>%
  dplyr::mutate(startDateTime = as_datetime(startDateTime)) %>%
  dplyr::mutate(date = as_date(startDateTime),
                hour = hour(startDateTime)) %>%
  dplyr::group_by(siteID, date, hour) %>%
  dplyr::summarize(TFPrecipBulk = mean(TFPrecipBulk, na.rm = TRUE)) %>%
  dplyr::mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  dplyr::select(siteID, startDateTime, TFPrecipBulk) %>%
  dplyr::mutate(siteID = site_change(siteID))

sensorData <- merge(oxy_cleaned, precipitation_cleaned, by=c("startDateTime", "siteID"))
```
Cleaning up and merging wind data
```{r}
wind_cleaned <- wind$WSDBuoy_30min %>%
  select(siteID, startDateTime, buoyWindSpeedMean) %>%
  mutate(startDateTime = as_datetime(startDateTime)) %>%
  mutate(date = as_date(startDateTime),
         hour = hour(startDateTime)) %>%
  group_by(siteID, date, hour) %>%
  filter(!(is.na(buoyWindSpeedMean))) %>%
  summarise(buoyWindSpeedMean = mean(buoyWindSpeedMean, na.rm = TRUE))  %>%
  mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  select(siteID, startDateTime, buoyWindSpeedMean)
  
sensorData <- sensorData %>% 
  merge(wind_cleaned, by=c("startDateTime", "siteID"))
```

Cleaning up and merging pressure data
```{r}
pressure_cleaned <- pressure$BP_30min %>%
  select(siteID, startDateTime, staPresMean) %>%
  mutate(startDateTime = as_datetime(startDateTime)) %>%
  mutate(date = as_date(startDateTime),
         hour = hour(startDateTime)) %>%
  group_by(siteID, date, hour) %>%
  filter(!(is.na(staPresMean))) %>%
  summarise(staPresMean = mean(staPresMean, na.rm = TRUE))  %>%
  mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  select(siteID, startDateTime, staPresMean)
  
sensorData <- sensorData %>% 
  merge(pressure_cleaned, by=c("startDateTime", "siteID"))
```

Cleaning up and merging temperature data
```{r}
temperature_cleaned <- temperature$RHbuoy_30min %>%
  select(siteID, startDateTime, tempRHMean) %>%
  mutate(startDateTime = as_datetime(startDateTime)) %>%
  mutate(date = as_date(startDateTime),
         hour = hour(startDateTime)) %>%
  group_by(siteID, date, hour) %>%
  filter(!(is.na(tempRHMean))) %>%
  summarise(tempRHMean = mean(tempRHMean, na.rm = TRUE))  %>%
  mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  select(siteID, startDateTime, tempRHMean)
  
sensorData <- sensorData %>% 
  merge(temperature_cleaned, by=c("startDateTime", "siteID"))
```

Cleaning up and merging surface water radiation data thats relevant to photosynthesis
```{r}
par_surface_cleaned <- par_surface$PARWS_30min %>%
  select(siteID, startDateTime, PARMean) %>%
  mutate(startDateTime = as_datetime(startDateTime)) %>%
  mutate(date = as_date(startDateTime),
         hour = hour(startDateTime)) %>%
  group_by(siteID, date, hour) %>%
  filter(!(is.na(PARMean))) %>%
  summarise(PARMean = mean(PARMean, na.rm = TRUE))  %>%
  mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  select(siteID, startDateTime, PARMean)
  
sensorData <- sensorData %>% 
  merge(par_surface_cleaned, by=c("startDateTime", "siteID"))
```

Cleaning up and merging below water radiation data thats relevant to photosynthesis
```{r}
par_below_cleaned <- par_below$uPAR_30min %>%
  select(siteID, startDateTime, uPARMean) %>%
  mutate(startDateTime = as_datetime(startDateTime)) %>%
  mutate(date = as_date(startDateTime),
         hour = hour(startDateTime)) %>%
  group_by(siteID, date, hour) %>%
  filter(!(is.na(uPARMean))) %>%
  summarise(uPARMean = mean(uPARMean, na.rm = TRUE))  %>%
  mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  select(siteID, startDateTime, uPARMean)
  
sensorData <- sensorData %>% 
  merge(par_below_cleaned, by=c("startDateTime", "siteID"))
```

Cleaning up and merging elevation data
```{r}
elevation_surface_cleaned <- elevation_surface$EOS_30_min %>%
  select(siteID, startDateTime, surfacewaterElevMean) %>%
  mutate(startDateTime = as_datetime(startDateTime)) %>%
  mutate(date = as_date(startDateTime),
         hour = hour(startDateTime)) %>%
  group_by(siteID, date, hour) %>%
  filter(!(is.na(surfacewaterElevMean))) %>%
  summarise(surfacewaterElevMean = mean(surfacewaterElevMean, na.rm = TRUE))  %>%
  mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  select(siteID, startDateTime, surfacewaterElevMean)
  
sensorData <- sensorData %>% 
  merge(elevation_surface_cleaned, by=c("startDateTime", "siteID"))
```

Cleaning up and merging groundwater temp data
```{r}
groundwater_temp_cleaned <- groundwater_temp$TGW_30_minute %>%
  select(siteID, startDateTime, groundwaterTempMean) %>%
  mutate(startDateTime = as_datetime(startDateTime)) %>%
  mutate(date = as_date(startDateTime),
         hour = hour(startDateTime)) %>%
  group_by(siteID, date, hour) %>%
  filter(!(is.na(groundwaterTempMean))) %>%
  summarise(groundwaterTempMean = mean(groundwaterTempMean, na.rm = TRUE))  %>%
  mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  select(siteID, startDateTime, groundwaterTempMean)
  
sensorData <- sensorData %>% 
  merge(groundwater_temp_cleaned, by=c("startDateTime", "siteID"))
```

```{r}
nitrate_surface_cleaned <- nitrate_surface$NSW_15_minute %>%
  select(siteID, startDateTime, surfWaterNitrateMean) %>%
  mutate(startDateTime = as_datetime(startDateTime)) %>%
  mutate(date = as_date(startDateTime),
         hour = hour(startDateTime)) %>%
  group_by(siteID, date, hour) %>%
  filter(!(is.na(surfWaterNitrateMean))) %>%
  summarise(surfWaterNitrateMean = mean(surfWaterNitrateMean, na.rm = TRUE))  %>%
  mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  select(siteID, startDateTime, surfWaterNitrateMean)
  
sensorData <- sensorData %>% 
  merge(nitrate_surface_cleaned, by=c("startDateTime", "siteID"))
```


```{r}
cleanedData <- sensorData %>%
  select(startDateTime, siteID, dissolvedOxygen, TFPrecipBulk, buoyWindSpeedMean, 
         staPresMean, tempRHMean, uPARMean, PARMean, surfacewaterElevMean,
         groundwaterTempMean, surfWaterNitrateMean)

write.csv(cleanedData, file='cleaned_data.csv', row.names = FALSE)
```

# Importing CSV and plotting!
Loading `cleanedData` csv
```{r}
impCleanedData <- read.csv("cleaned_data.csv")
```

Plotting variables against DO
```{r}
x_names <- names(impCleanedData)[4:ncol(impCleanedData)] 
for (i in x_names){
  plt <- impCleanedData %>% 
    ggplot(aes_string(x = i, y = "dissolvedOxygen")) +
    geom_point()
  print(plt)
}
```